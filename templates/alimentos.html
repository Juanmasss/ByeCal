<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ByeCal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='ByeCal.ico') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <!-- Toastify JS -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <!-- Tu script -->
  <script src="{{ url_for('static', filename='js/toast.js') }}"></script>
    
    <div class="container-alimentos">

        <h1 style="margin-top:0;">Buscar alimento</h1>

        <form method="POST" action="{{ url_for('alimentos') }}" style="margin-bottom: 14px;">
            <label for="nombre">Nombre del alimento:</label>
            <input type="text" id="nombre" name="nombre" required style="width:100%; max-width: 620px;">
            <button type="submit" class="btn btn-red" style="margin-top:10px;"
                    style="display:block; margin-top:10px; padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                Buscar
            </button>
        </form>

        {% if info %}
        <div class="resultado" style="margin-top: 16px;">
            <h2>Informaci√≥n Nutricional</h2>
            <div class="info-contenedor" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
                <div class="texto" style="min-width:260px;">
                    <ul>
                        <li><strong>Nombre:</strong> {{ info.nombre }}</li>
                        <li><strong>Calor√≠as:</strong> {{ info.calorias }} kcal</li>
                        <li><strong>Prote√≠nas:</strong> {{ info.proteinas }} g</li>
                        <li><strong>Grasas:</strong> {{ info.grasas }} g</li>
                        <li><strong>Carbohidratos:</strong> {{ info.carbohidratos }} g</li>
                    </ul>
                </div>
                {% if info.imagen %}
                <div class="imagen" style="flex:0 0 auto;">
                    <img src="{{ info.imagen }}" alt="Imagen {{ info.nombre }}" style="max-height:140px; border-radius:8px;">
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <h2 style="margin-top:24px;">Historial reciente</h2>
        <div style="overflow-x:auto;">
            <table class="tabla-alimentos" style="width:100%; border-collapse: collapse; min-width:700px;">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Calor√≠as</th>
                        <th>Prote√≠nas</th>
                        <th>Grasas</th>
                        <th>Carbohidratos</th>
                        <th>Agregar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alimento in historial %}
                    <tr>
                        <td>{{ alimento.nombre }}</td>
                        <td>{{ alimento.calorias }}</td>
                        <td>{{ alimento.proteinas }}</td>
                        <td>{{ alimento.grasas }}</td>
                        <td>{{ alimento.carbohidratos }}</td>
                        <td>
                            <button class="btn btn-red agregar-btn"
                                    data-id="{{ alimento.id }}"
                                    data-nombre="{{ alimento.nombre }}"
                                    data-calorias="{{ alimento.calorias }}">
                                Agregar alimento
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if historial|length == 0 %}
                    <tr>
                        <td colspan="6" style="text-align:center; opacity:.8;">Sin registros recientes.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div style="margin-top: 14px;">
            <a class="link" href="{{ url_for('calculadora') }}">Volver a calculadora</a>
            <span style="opacity:.35;"> &nbsp;‚Ä¢&nbsp; </span>
            <a class="link" href="{{ url_for('dashboard') }}">Volver al inicio</a>
            <span style="opacity:.35;"> &nbsp;‚Ä¢&nbsp; </span>
            <a class="link" href="{{ url_for('agregar_alimentos') }}">Ver alimentos consumidos</a>
        </div>
    </div>

    <script>
  document.querySelectorAll(".agregar-btn").forEach(btn => {
    btn.addEventListener("click", function (event) {
      event.preventDefault();

      const alimentoId = this.dataset.id;

      fetch("{{ url_for('agregar_consumo') }}", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `alimento_id=${alimentoId}&porcion=100 g`
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // ‚úÖ antes era alert(...)
          toastOk(`ü•ó ${data.consumo.nombre} agregado con √©xito`);
        } else {
          toastErr(data.message || "Error al agregar alimento");
        }
      })
      .catch(err => {
        console.error(err);
        toastErr("Hubo un error con el servidor");
      });
    });
  });
</script>
</body>
</html>